blueprint:
  name: "ZHA - Tuya TS004F Rotating Knob - 5 Mode Selector"
  description: >
    Wählt einen von 5 Modi per Drehung des Tuya TS004F Knopfes aus.
    Die aktuelle Auswahl wird durch ein RGB-Indikatorlicht angezeigt.
    Ein kurzer Druck startet das zugehörige Skript.

  domain: automation

  input:
    remote:
      name: Tuya TS004F Rotating Knob
      description: Wähle den Drehknopf.
      selector:
        device:
          integration: zha
          model: TS004F

    indicator_light:
      name: Indikator-Licht
      description: RGB-Leuchte, die den aktuellen Modus anzeigt.
      selector:
        entity:
          domain: light

    script_1:
      name: Skript 1
      description: Skript für Modus 1 (Rot)
      selector:
        entity:
          domain: script

    script_2:
      name: Skript 2
      description: Skript für Modus 2 (Grün)
      selector:
        entity:
          domain: script

    script_3:
      name: Skript 3
      description: Skript für Modus 3 (Blau)
      selector:
        entity:
          domain: script

    script_4:
      name: Skript 4
      description: Skript für Modus 4 (Gelb)
      selector:
        entity:
          domain: script

    script_5:
      name: Skript 5
      description: Skript für Modus 5 (Lila)
      selector:
        entity:
          domain: script

mode: restart
max_exceeded: silent

variables:
  modes:
    0: { name: "Modus 1", color: [0, 100], script: !input script_1 }      # Rot
    1: { name: "Modus 2", color: [120, 100], script: !input script_2 }    # Grün
    2: { name: "Modus 3", color: [240, 100], script: !input script_3 }    # Blau
    3: { name: "Modus 4", color: [50, 100], script: !input script_4 }     # Gelb
    4: { name: "Modus 5", color: [280, 100], script: !input script_5 }    # Lila

  current_index: 0

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input remote

action:
  - variables:
      command: "{{ trigger.event.data.command }}"

  - choose:
      ### Drehung: Modus wechseln ###
      - conditions:
          - "{{ command == 'left' or command == 'right' }}"
        sequence:
          - variables:
              current_index: >-
                {% if command == 'right' %}
                  {{ (current_index + 1) % 5 }}
                {% else %}
                  {{ (current_index - 1) % 5 }}
                {% endif %}
              selected_mode: "{{ modes[current_index] }}"
          - service: light.turn_on
            target:
              entity_id: !input indicator_light
            data:
              hs_color: "{{ selected_mode.color }}"

      ### Kurzer Druck: Skript starten ###
      - conditions:
          - "{{ command == 'remote_button_short_press' }}"
        sequence:
          - service: script.turn_on
            target:
              entity_id: "{{ selected_mode.script }}"
          - service: light.turn_on
            target:
              entity_id: !input indicator_light
            data:
              hs_color: "{{ selected_mode.color }}"
          - delay: "00:00:01"
          - service: light.turn_off
            target:
              entity_id: !input indicator_light
          - delay: "00:00:50"
          - service: light.turn_on
            target:
              entity_id: !input indicator_light
            data:
              hs_color: "{{ selected_mode.color }}"
